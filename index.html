<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>hello phaser!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.9.4/phaser.min.js"></script>
</head>

<body>

    <script type="text/javascript">

        window.onload = function () {
            var LEVEL_0 = 'map0'
            var LEVEL_1 = 'map1'
            var LEVEL_2 = 'map2'
            var LEVEL_3 = 'map3'
            var LEVEL_4 = 'map4'

            var DIRECTION_UP = "up";
            var DIRECTION_DOWN = "down";
            var DIRECTION_LEFT = "left";
            var DIRECTION_RIGHT = "right";

            var game = new Phaser.Game(580, 580, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render });

            function preload() {
                game.load.tilemap('map0', 'assets/tilemaps/csv/catastrophi_level2.csv?12356', null, Phaser.Tilemap.CSV);
                game.load.tilemap('map1', 'assets/tilemaps/csv/test_level1.csv', null, Phaser.Tilemap.CSV);
                game.load.image('tiles', 'assets/tilemaps/tiles/catastrophi_tiles_16.png');
                game.load.image('sword', 'assets/sprites/sword.png');
                game.load.image('hero_front','assets/sprites/hero/front.png');
                game.load.image('hero_left','assets/sprites/hero/left.png');
                game.load.image('hero_right','assets/sprites/hero/right.png');
                game.load.image('hero_back','assets/sprites/hero/back.png');

                game.load.image('amoeba1', 'assets/sprites/amoeba/amoeba1.png');
                game.load.image('spider', 'assets/sprites/monsters/CatSpider.png');
                game.load.image('skeleton', 'assets/sprites/monsters/Skeleton.png');
            }

            var map;
            var layer;
            var cursors;
            var player;
            var weapon;
            var debug;
            var fireButton;
            var runButton;
            var facingDirection;
            var monsters = [];
            var exits = {};
            var currentLevel;
            var levels = [
                {
                    mapKey: "map0",
                    monsters: [
                        {x: 350, y: 250, key: "spider", scale: 3, health: 3 },
                        {x: 250, y: 350, key: "skeleton", scale: 2, health: 3 }
                    ],
                    exits: { 'top': 1, }
                },
                {
                    mapKey: "map1",
                    monsters: [
                        {x: 350, y: 250, key: "spider", scale: 3, health: 3 },
                        {x: 250, y: 350, key: "skeleton", scale: 2, health: 3 },
                        {x: 250, y: 350, key: "skeleton", scale: 2, health: 3 },
                    ],
                    exits: { 'bottom': 0 }
                }
            ]

            function loadHero(x, y, health) {
                facingDirection = DIRECTION_DOWN;
                player = game.add.sprite(x, y, 'hero_front')
                player.scale.setTo(2,2);
                weapon = game.add.weapon(1, 'sword');
                weapon.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
                weapon.bulletSpeed = 500;
                weapon.trackSprite(player, 14, 0);
                game.physics.arcade.enable(player);

                player.health = health;
                player.invulnerable = 0;
                player.body.collideWorldBounds = true;
                player.anchor.setTo(0.5,0.5);
            }

            function unload(){
                monsters.forEach(e=> {
                    e.kill();
                })
            }

            function loadLevel(levelIndex){
                currentLevel = levelIndex;
                levelObj = levels[currentLevel];
                map = game.add.tilemap(levelObj.mapKey, 16, 16);
                map.addTilesetImage('tiles');
                layer = map.createLayer(0);
                layer.scale.set(3.0);
                layer.resizeWorld();

                levelObj.monsters.forEach(e=> {
                    monsters.push(initializeMonster(e));
                })
            }

            function initializeMonster(monObj){
                var monster =  game.add.sprite(monObj.x, monObj.y, monObj.key);
                monster.scale.set(monObj.scale)
                monster.health = monObj.health;
                game.physics.arcade.enable(monster)
                game.time.events.loop(2000, function() { 
                        game.add.tween(monster).to({x: game.world.randomX, y: game.world.randomY}, 1750, Phaser.Easing.Quadratic.InOut, true);
                    }, 
                    this)
                monster.body.collideWorldBounds = true;
                return monster;
            }
            
            function collisionHandler(monster, bullet){
                bullet.kill();
                monster.health -= 1;
                if(monster.health <= 0){
                    monster.kill();
                }
            }

            function playerHit(by, damage){
                if(player.invulnerable > 0)
                {
                    return;
                }
                player.health -= 1;
                if(player.health <= 0){
                    player.kill();
                    loadHero(100, 100, 3);
                }
                else {
                    player.invulnerable = 60;
                }
            }

            function create() {
                loadLevel(0);
                debug = game.add.text(16, 16, 'Hello world', { font: '14px Arial', fill: '#ffffff' });
                debug.fixedToCamera = true;
                loadHero(100, 100, 3);
                cursors = game.input.keyboard.createCursorKeys();
                fireButton = game.input.keyboard.addKey(Phaser.KeyCode.SPACEBAR);
                runButton = game.input.keyboard.addKey(Phaser.KeyCode.SHIFT);
                exits = [
                    { key: 'top', bounds: new Phaser.Rectangle(50, 0, game.world.width - 100, 50) },
                    { key: 'bottom', bounds: new Phaser.Rectangle(50, game.world.height - 60, game.world.width - 100, 50) },
                    { key: 'left', bounds: new Phaser.Rectangle(0, 50, 50, game.world.height - 100) },
                    { key: 'right', bounds: new Phaser.Rectangle(game.world.width - 50, 50, 50, game.world.height - 100) },
                ]
            }

            function update() {
                player.invulnerable -= 1;
                updateInput()
                game.physics.arcade.overlap(weapon.bullets, monsters, collisionHandler, null, this);
                game.physics.arcade.overlap(player, monsters, playerHit, null, this);
                exits.forEach(e=> {
                    if(e.bounds.contains(player.position.x, player.position.y)) {
                        if(levels[currentLevel].exits[e.key]) {
                            unload();
                            loadLevel(levels[currentLevel].exits[e.key])
                            loadHero(50, 50, player.health);
                        }
                    }
                })
                debug.text = player.health;
            }

            function render() {
                exits.forEach(e=> {
                    game.debug.geom(e.bounds, "#0fffff")
                });
            }
            var walkSpeed = 200;
            var runSpeed = 450;
            var accel = 25;
            var moveDistance = 200;
            function updateInput(){
                if(runButton.isDown)
                {
                    if(moveDistance < runSpeed) {
                         moveDistance += 25;
                    } else moveDistance = runSpeed;
                }
                else{
                    if(moveDistance > walkSpeed) {
                        moveDistance -= 25;
                    }
                    else moveDistance = walkSpeed;
                }
                player.body.velocity.setTo(0, 0);
                if (cursors.up.isDown)
                {
                    if(facingDirection == DIRECTION_UP){
                        player.body.velocity.y -= moveDistance
                    }
                    facingDirection = DIRECTION_UP;
                    player.loadTexture('hero_back', 0)
                }
                else if (cursors.down.isDown)
                {
                    if(facingDirection == DIRECTION_DOWN){
                        player.body.velocity.y += moveDistance;
                    }
                    facingDirection = DIRECTION_DOWN;
                    player.loadTexture('hero_front', 0)
                }
                if (cursors.left.isDown)
                {
                    if(facingDirection == DIRECTION_LEFT){
                        player.body.velocity.x -= moveDistance;
                    }
                    facingDirection = DIRECTION_LEFT
                    player.loadTexture('hero_left', 0)
                }
                else if (cursors.right.isDown)
                {
                    if(facingDirection == DIRECTION_RIGHT){
                        player.body.velocity.x += moveDistance;
                    }
                    facingDirection = DIRECTION_RIGHT;
                    player.loadTexture('hero_right', 0)
                }
            
                if (fireButton.isDown)
                {
                    var offset = getRotationDirection(facingDirection);
                    weapon.fireAngle = offset;
                    weapon.bulletAngleOffset = facingDirection == DIRECTION_LEFT || facingDirection == DIRECTION_RIGHT
                        ? 90
                        : 270;
                    sword = weapon.fire();
                }
            }

            function getRotationDirection(dir){
                switch(dir){
                    case DIRECTION_UP: return 270;
                    case DIRECTION_LEFT: return 180;
                    case DIRECTION_DOWN: return 90;
                    case DIRECTION_RIGHT: return 0; 
                    default: 0;
                }
            }
        };


    </script>

</body>

</html>