<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>hello phaser!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.9.4/phaser.min.js"></script>
</head>

<body>

    <script type="text/javascript">

        window.onload = function () {

            var DIRECTION_UP = "up";
            var DIRECTION_DOWN = "down";
            var DIRECTION_LEFT = "left";
            var DIRECTION_RIGHT = "right";

            var game = new Phaser.Game(580, 580, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render });

            function preload() {
                game.load.tilemap('map', 'assets/tilemaps/csv/catastrophi_level2.csv?12356', null, Phaser.Tilemap.CSV);
                game.load.image('tiles', 'assets/tilemaps/tiles/catastrophi_tiles_16.png');
                game.load.image('sword', 'assets/sprites/sword.png');
                game.load.image('hero_front','assets/sprites/hero/front.png');
                game.load.image('hero_left','assets/sprites/hero/left.png');
                game.load.image('hero_right','assets/sprites/hero/right.png');
                game.load.image('hero_back','assets/sprites/hero/back.png');

                game.load.image('amoeba1', 'assets/sprites/amoeba/amoeba1.png');
                game.load.image('spider', 'assets/sprites/monsters/CatSpider.png');
            }

            var map;
            var layer;
            var cursors;
            var player;
            var weapon;
            var debug;
            var fireButton;
            var facingDirection;
            var monsters = [];

            function initializeHero() {
                facingDirection = DIRECTION_DOWN;
                player = game.add.sprite(50, 50, 'hero_front')
                player.scale.setTo(2,2);
                weapon = game.add.weapon(1, 'sword');
                weapon.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
                weapon.bulletSpeed = 500;
                weapon.trackSprite(player, 14, 0);
                game.physics.arcade.enable(player);

                player.health = 3;
                player.invulnerable = 0;
            }

            function initializeWorld(){
                map = game.add.tilemap('map', 16, 16);
                map.addTilesetImage('tiles');
                layer = map.createLayer(0);
                layer.scale.set(3.0);
                layer.resizeWorld();
            }
            function initializeMonster(x,y, key){
                var monster =  game.add.sprite(x, y, key);
                monster.scale.set(2.0)
                monster.health = 3;
                game.physics.arcade.enable(monster)
                game.time.events.loop(2000, function() { 
                        game.add.tween(monster).to({x: game.world.randomX, y: game.world.randomY}, 1750, Phaser.Easing.Quadratic.InOut, true);
                    }, 
                    this)
                return monster;
            }
            function collisionHandler(monster, bullet){
                bullet.kill();
                monster.health -= 1;
                if(monster.health <= 0){
                    monster.kill();
                }
            }

            function playerHit(by, damage){
                if(player.invulnerable > 0)
                {
                    return;
                }
                player.health -= 1;
                if(player.health <= 0){
                    player.kill();
                    initializeHero();
                }
                else {
                    player.invulnerable = 60;
                }
            }

            function create() {
                initializeWorld();
                debug = game.add.text(16, 16, 'Hello world', { font: '14px Arial', fill: '#ffffff' });
                debug.fixedToCamera = true;
                initializeHero();
                cursors = game.input.keyboard.createCursorKeys();
                fireButton = game.input.keyboard.addKey(Phaser.KeyCode.SPACEBAR);
                monsters.push(initializeMonster(400, 350, 'spider'))
                monsters.push(initializeMonster(350, 400, 'spider'))
            }

            function update() {
                player.invulnerable -= 1;
                updateInput()
                game.physics.arcade.overlap(weapon.bullets, monsters, collisionHandler, null, this);
                game.physics.arcade.overlap(player, monsters, playerHit, null, this);
                debug.text = player.health;
            }

            function render() {

            }
            function updateInput(){
                moveDistance = 200;
                player.body.velocity.setTo(0, 0);
                if (cursors.up.isDown)
                {
                    if(facingDirection == DIRECTION_UP){
                        player.body.velocity.y -= moveDistance
                    }
                    facingDirection = DIRECTION_UP;
                    player.loadTexture('hero_back', 0)
                }
                else if (cursors.down.isDown)
                {
                    if(facingDirection == DIRECTION_DOWN){
                        player.body.velocity.y += moveDistance;
                    }
                    facingDirection = DIRECTION_DOWN;
                    player.loadTexture('hero_front', 0)
                }
                if (cursors.left.isDown)
                {
                    if(facingDirection == DIRECTION_LEFT){
                        player.body.velocity.x -= moveDistance;
                    }
                    facingDirection = DIRECTION_LEFT
                    player.loadTexture('hero_left', 0)
                }
                else if (cursors.right.isDown)
                {
                    if(facingDirection == DIRECTION_RIGHT){
                        player.body.velocity.x += moveDistance;
                    }
                    facingDirection = DIRECTION_RIGHT;
                    player.loadTexture('hero_right', 0)
                }
            
                if (fireButton.isDown)
                {
                    var offset = getRotationDirection(facingDirection);
                    weapon.fireAngle = offset;
                    weapon.bulletAngleOffset = facingDirection == DIRECTION_LEFT || facingDirection == DIRECTION_RIGHT
                        ? 90
                        : 270;
                    sword = weapon.fire();
                }
            }

            function getRotationDirection(dir){
                switch(dir){
                    case DIRECTION_UP: return 270;
                    case DIRECTION_LEFT: return 180;
                    case DIRECTION_DOWN: return 90;
                    case DIRECTION_RIGHT: return 0; 
                    default: 0;
                }
            }
        };


    </script>

</body>

</html>