<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>hello phaser!</title>
    <script src="phaser.min.js"></script>
</head>

<body>

    <script type="text/javascript">
class Link extends Phaser.Sprite {
    constructor( opts ){
        super( opts.game, opts.x || 0, opts.y || 0, opts.key || '', opts.frame || '' )

        // Enable player physics
        this.game.physics.enable( this, Phaser.Physics.ARCADE )

        // Player specifics
        this.body.collideWorldBounds = opts.hasOwnProperty('collideWorldBounds') ? opts.collideWorldBounds : true
        this.body.setSize( opts.width || 64, opts.height || 64 )
        this.health = opts.health || 1

        // Shortcut to current state object
        this.state = this.game.state.states[this.game.state.current]

        // Set up speed values
        this.speed = opts.speed || 350

        // Set up controls
        if( opts.hasOwnProperty('controls') ){
            this.cursors = this.game.input.keyboard.createCursorKeys()
        }

        // Set up diagonal movement dampener
        this.matchDiagonalSpeed =  opts.matchDiagonalSpeed || true

        // Shortcut to inverse of Pythagorean constant
        // (used to make diagonal speed match straight speed)
        this.pythInverse = 1 / Math.SQRT2
    }

    update(){
        // basic living/dying checks
        if( !this.alive ) return
        if( this.health <= 0 ){
            this.die()
        }

        // horizontal movement
        if( this.cursors.left.isDown ){
            this.body.velocity.x = -1
        } else if ( this.cursors.right.isDown ){
            this.body.velocity.x = 1
        } else {
            this.body.velocity.x = 0
        }

        // vertical movement
        if( this.cursors.up.isDown ){
            this.body.velocity.y = -1
        } else if ( this.cursors.down.isDown ){
            this.body.velocity.y = 1
        } else {
            this.body.velocity.y = 0
        }

        // If the player is moving diagonally, the resultant vector
        // will have a magnitude greather than the defined speed.
        // This section makes the magnitude of the player's movement
        // match the defined speed.
        let targetSpeed =
            (this.body.velocity.x != 0 && this.body.velocity.y != 0) ?
            this.speed * this.pythInverse :
            this.speed

        this.body.velocity.x *= targetSpeed
        this.body.velocity.y *= targetSpeed
    }
}
        window.onload = function () {
            var LEVEL_0 = 'map0'
            var LEVEL_1 = 'map1'
            var LEVEL_2 = 'map2'
            var LEVEL_3 = 'map3'
            var LEVEL_4 = 'map4'

            var DIRECTION_UP = "up";
            var DIRECTION_DOWN = "down";
            var DIRECTION_LEFT = "left";
            var DIRECTION_RIGHT = "right";

            var game = new Phaser.Game(580, 580, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render });

            function preload() {
                game.load.tilemap('map0', 'assets/tilemaps/csv/catastrophi_level2.csv?12356', null, Phaser.Tilemap.CSV);
                game.load.tilemap('map1', 'assets/tilemaps/csv/catastrophi_level2.csv?12356', null, Phaser.Tilemap.CSV);
                game.load.image('tiles', 'assets/tilemaps/tiles/catastrophi_tiles_16.png');
                game.load.image('sword', 'assets/sprites/sword.png');
                game.load.image('hero_front','assets/sprites/hero/front.png');
                game.load.image('hero_left','assets/sprites/hero/left.png');
                game.load.image('hero_right','assets/sprites/hero/right.png');
                game.load.image('hero_back','assets/sprites/hero/back.png');

                game.load.image('amoeba1', 'assets/sprites/amoeba/amoeba1.png');
                game.load.image('spider', 'assets/sprites/monsters/CatSpider.png');
                game.load.image('skeleton', 'assets/sprites/monsters/Skeleton.png');
            }

            var map;
            var layer;
            var cursors;
            var player;
            var weapon;
            var debug;
            var fireButton;
            var runButton;
            var facingDirection;
            var monsters = [];

            var level0 = {
                mapKey: "map0",
                monsters: [
                    {x: 350, y: 250, key: "spider", scale: 3, health: 3 },
                    {x: 250, y: 350, key: "skeleton", scale: 2, health: 3 }
                ]
            }

            function initializeHero() {
                player = new Link({
                    game: game,
                    key: 'hero_right',
                    controls: true,
                    x:50,
                    y:50
                });
                player.position
                game.add.existing(player);

                facingDirection = DIRECTION_DOWN;
                // player = game.add.sprite(50, 50, 'hero_front')
                // player.scale.setTo(2,2);
                weapon = game.add.weapon(1, 'sword');
                weapon.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
                weapon.bulletSpeed = 500;
                weapon.trackSprite(player, 14, 0);
                game.physics.arcade.enable(player);

                player.health = 3;
                player.invulnerable = 0;
                player.body.collideWorldBounds = true;
            }

            function unload(){
                monsters.foreach(e=> {
                    e.kill();
                })
            }

            function loadLevel(levelObj){
                map = game.add.tilemap(levelObj.mapKey, 16, 16);
                map.addTilesetImage('tiles');
                layer = map.createLayer(0);
                layer.scale.set(3.0);
                layer.resizeWorld();

                levelObj.monsters.forEach(e=> {
                    monsters.push(initializeMonster(e));
                })
            }

            function initializeMonster(monObj){
                var monster =  game.add.sprite(monObj.x, monObj.y, monObj.key);
                monster.scale.set(monObj.scale)
                monster.health = monObj.health;
                game.physics.arcade.enable(monster)
                game.time.events.loop(2000, function() { 
                        game.add.tween(monster).to({x: game.world.randomX, y: game.world.randomY}, 1750, Phaser.Easing.Quadratic.InOut, true);
                    }, 
                    this)
                monster.body.collideWorldBounds = true;
                return monster;
            }
            
            function collisionHandler(monster, bullet){
                bullet.kill();
                monster.health -= 1;
                if(monster.health <= 0){
                    monster.kill();
                }
            }

            function playerHit(by, damage){
                if(player.invulnerable > 0)
                {
                    return;
                }
                player.health -= 1;
                if(player.health <= 0){
                    player.kill();
                    initializeHero();
                }
                else {
                    player.invulnerable = 60;
                }
            }

            function create() {
                loadLevel(level0);
                debug = game.add.text(16, 16, 'Hello world', { font: '14px Arial', fill: '#ffffff' });
                debug.fixedToCamera = true;
                initializeHero();
                cursors = game.input.keyboard.createCursorKeys();
                fireButton = game.input.keyboard.addKey(Phaser.KeyCode.SPACEBAR);
                runButton = game.input.keyboard.addKey(Phaser.KeyCode.SHIFT);
            }

            function update() {
                player.invulnerable -= 1;
                updateInput()
                game.physics.arcade.overlap(weapon.bullets, monsters, collisionHandler, null, this);
                game.physics.arcade.overlap(player, monsters, playerHit, null, this);
                debug.text = player.health;
            }

            function render() {

            }
            var walkSpeed = 200;
            var runSpeed = 450;
            var accel = 25;
            var moveDistance = 200;
            function updateInput(){
                if(runButton.isDown)
                {
                    if(moveDistance < runSpeed) {
                         moveDistance += 25;
                    } else moveDistance = runSpeed;
                }
                else{
                    if(moveDistance > walkSpeed) {
                        moveDistance -= 25;
                    }
                    else moveDistance = walkSpeed;
                }
                if (cursors.up.isDown)
                {
                    facingDirection = DIRECTION_UP;
                    player.loadTexture('hero_back', 0)
                }
                else if (cursors.down.isDown)
                {
                    facingDirection = DIRECTION_DOWN;
                    player.loadTexture('hero_front', 0)
                }
                if (cursors.left.isDown)
                {
                    facingDirection = DIRECTION_LEFT
                    player.loadTexture('hero_left', 0)
                }
                else if (cursors.right.isDown)
                {
                    facingDirection = DIRECTION_RIGHT;
                    player.loadTexture('hero_right', 0)
                }
            
                if (fireButton.isDown)
                {
                    var offset = getRotationDirection(facingDirection);
                    weapon.fireAngle = offset;
                    weapon.bulletAngleOffset = facingDirection == DIRECTION_LEFT || facingDirection == DIRECTION_RIGHT
                        ? 90
                        : 270;
                    sword = weapon.fire();
                }
            }

            function getRotationDirection(dir){
                switch(dir){
                    case DIRECTION_UP: return 270;
                    case DIRECTION_LEFT: return 180;
                    case DIRECTION_DOWN: return 90;
                    case DIRECTION_RIGHT: return 0; 
                    default: 0;
                }
            }
        };
 


    </script>

</body>

</html>